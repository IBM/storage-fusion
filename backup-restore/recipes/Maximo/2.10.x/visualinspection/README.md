Backup
----
For detailed information about IBM Fusion resources such as backup policy, recipes and backup storage location, please refer the [Backing up and restoring with IBM Fusion](https://www.ibm.com/docs/en/masv-and-l/continuous-delivery?topic=suite-backing-up-restoring-storage-fusion#taskt_backing_up_and_restoring_with_ibm_fusion__steps__1) section in MAS documentation <br>

### Steps for Maximo Visual Inspection namespace backup

1. cd to `maximo/visualinspection`
2. Export Visual Inspection required variables, this can be achieving by sourcing the `maximo_env.sh`:
    ```
    MAS_INSTANCE_ID (REQUIRED)
    MAS_WORKSPACE_ID (REQUIRED)
    ```

    e.g
    `export MAS_INSTANCE_ID=inst1`
    `export MAS_WORKSPACE_ID=dev`


3. Run the prerequisite script, for more information, run with the `-h` option

    `./scripts/backup-pre-req.sh`

4. Apply the local recipe (frcpe) generated by the backup-pre-req script

    `oc apply -f maximo-visualinspection-backup-restore-local.yaml`

**Note:** Following steps needs to be made on Hub cluster

5. From Fusion Console, create backup policy (fbp) specifying the frequency for backups
6. From Fusion Console, associate the backup policy to the Visual Inspection application. 
7. Retrieve the Policy Assignment Name:

    `oc get fpa -n ibm-spectrum-fusion-ns -o custom-columns=NAME:.metadata.name --no-headers`
8. Update policy assignments (fpa) with recipe name and namespace

    `oc -n ibm-spectrum-fusion-ns patch fpa <policy-assignment-name> --type merge -p '{"spec":{"recipe":{"name":"maximo-visualinspection-backup-restore-recipe", "namespace":"ibm-spectrum-fusion-ns"}}}'`
    ```
    recipe:
        name: maximo-visualinspection-backup-restore-recipe
        namespace: ibm-spectrum-fusion-ns
    ```

Restore
----
### Prerequisite: 
**Required:** <br>
1. Restore Maximo Application Suite with either [Suite](../suite/README.md) or [Core](../core/README.md) recipes and its optional prerequisites <br>
2. NVIDIA GPU Operator and the Node Feature Discovery Operator either manually or with Maximo automation: [nvidia_gpu](https://ibm-mas.github.io/ansible-devops/roles/nvidia_gpu/)

**Optional:** <br>
3. [Grafana](https://ibm-mas.github.io/ansible-devops/roles/grafana/): You must install same version (v4 or v5) as in source cluster if you were previously using Grafana <br>

### Steps for Maximo Visual Inspection namespace restore
1. Before restoring application run the prerequisite script:

    `./scripts/restore-pre-req.sh`
2. Start Visual Inspection namespace restore to same or alternate cluster. For detailed procedure on how to restore an application with IBM Fusion, please refer to detailed steps in [Restoring Maximo Application Suite with IBM Fusion](https://www.ibm.com/docs/en/masv-and-l/continuous-delivery?topic=suite-backing-up-restoring-storage-fusion#restore_mas_w_fusion__title__1)

### Post Restore Task

After Visual Inspection application is restored, there are post restore task that needs to be manually made. 
1. Access to Visual Inspection application
2. From the left navigation panel, select Deployed Models
3. The list of deployed models will be shown as Ready, however, this is not accurate as the models are not deployed during restore. 
4. Select all deployed models and Undeploy them. 
5. An error will pop up as the resources for the deployed model can't be located, we can discard this warning. 
6. Refresh the page by using F5 or the refresh button from the browser. 
7. After refresh, there will be no more deployed models. 
8. From the left navigation panel, select Models and manually deploy the models you require. 
9. After a while, the model will be deployed and marked as Ready. 
