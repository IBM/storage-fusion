Recipe Enhancement Available
----

If using MongoDB community edition and IBM SLS alongside Maximo, the prefered recipe is available at [suite](../suite/) directory. 
This is a recipe enhancement that will take care of protecting the 3 namespaces e.g. (mongoce, ibm-sls, core) with a single recipe. 

The recipe in this directory is also available to use but will require that MongoDB and IBM SLS namespaces to be backed up individually. 

Backup
----
For detailed information about IBM Fusion resources such as backup policy, recipes and backup storage location, please refer the [Backing up and restoring with IBM Fusion](https://www.ibm.com/docs/en/masv-and-l/continuous-delivery?topic=suite-backing-up-restoring-storage-fusion#taskt_backing_up_and_restoring_with_ibm_fusion__steps__1) section in MAS documentation <br>

### Steps for Maximo Core namespace backup

1. cd to `maximo/core`
2. Export Core required variables, this can be achieving by sourcing the `maximo_env.sh`:
    ```
    MAS_INSTANCE_ID (REQUIRED)
    REPORTING_OPERATOR (OPTIONAL, default: dro)
    REPORTING_OPERATOR_NAMESPACE (OPTIONAL, default: redhat-marketplace)
    KAFKA_NAMESPACE (Optional if installed in cluster)
    ```

    e.g
    `export MAS_INSTANCE_ID=inst1`


2. Run the prerequisite script, for more information, run with the `-h` option

    `./scripts/backup-pre-req.sh`

3. Apply the local recipe (frcpe) generated by the backup-pre-req script
   
    `oc apply -f maximo-core-backup-restore-local.yaml`

**Note:** Following steps needs to be made on Hub cluster

4. From Fusion Console, create backup policy (fbp) specifying the frequency for backups
5. From Fusion Console, associate the backup policy to the Core application. 
6.  Retrieve the Policy Assignment Name:

    `oc get fpa -n ibm-spectrum-fusion-ns -o custom-columns=NAME:.metadata.name --no-headers`
7.  Update policy assignments (fpa) with recipe name and namespace

    `oc -n ibm-spectrum-fusion-ns patch fpa <policy-assignment-name> --type merge -p '{"spec":{"recipe":{"name":"maximo-core-backup-restore-recipe", "namespace":"ibm-spectrum-fusion-ns"}}}'`
    ```
    recipe:
        name: maximo-core-backup-restore-recipe
        namespace: ibm-spectrum-fusion-ns
    ```

Restore
----
### Prerequisites:
**Required:** <br>
1. RH [cert-manager](https://ibm-mas.github.io/ansible-devops/roles/cert_manager/) <br>
2. Maximo [ibm-operator-catalog](https://ibm-mas.github.io/ansible-devops/roles/ibm_catalogs/) <br>
3. Data Reporter Operator [(dro)](https://ibm-mas.github.io/ansible-devops/roles/dro/)  <br>
4. Restore [MongoDB](../mongodb/README.md) namespace <br>
5. Restore IBM [SLS](../sls/README.md) namespace <br>

**Optional:** <br>
6. [Grafana](https://ibm-mas.github.io/ansible-devops/roles/grafana/): You must install same version (v4 or v5) as in source cluster if you were previously using Grafana <br>
7. Restore [DB2](../db2u/README.md) namespace if configured in source cluster <br>
8. Restore [AMQ-Streams](../amq-streams/README.md) namespace if configured in source cluster


### Steps for Maximo Core namespace restore
1. Before restoring application run the prerequisite script:

    `./scripts/restore-pre-req.sh`
2. Start Core namespace restore to same or alternate cluster. For detailed procedure on how to restore an application with IBM Fusion, please refer to detailed steps in [Restoring Maximo Application Suite with IBM Fusion](https://www.ibm.com/docs/en/masv-and-l/continuous-delivery?topic=suite-backing-up-restoring-storage-fusion#restore_mas_w_fusion__title__1)
